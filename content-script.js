(() => {

  const mockData = [{
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: true,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }]
  const CTRL_KEY_CODE = 17
  const TAB_KEY_CODE = 81
  let MAX_TAB_LENGTH = (200 / 28) >> 0
  let showFlag = false
  let activeIndex = null
  let tabsNum = 0
  let tabsList = []
  let activeTab = null
  const {
    runtime
  } = chrome

  document.addEventListener('keydown', e => {
    let currKey = e.keyCode
    if (e.ctrlKey && currKey === TAB_KEY_CODE) {
      if (showFlag) {
        if (activeIndex >= 0) {
          ++activeIndex
          if (activeIndex === (tabsNum - 1)) activeIndex = 0
          setActiveIndex(activeIndex)
          setScrollPos(activeIndex)
        }
      } else {
        setTabsListStyle()
        runtime.sendMessage({
          greeting: 'Hello'
        }, ({
          arrTabs
        }) => {
          createTabWrapper(arrTabs)
        })
        // createTabWrapper(mockData, cleanTabWrapper)
      }
      // setTabsListStyle()
    }
  })

  document.addEventListener('keyup', e => {
    if (!e.ctrlKey && e.keyCode === CTRL_KEY_CODE) {
      let tabWrapper = document.querySelector('#tab-wrapper')
      document.body.removeChild(tabWrapper)
      showFlag = false

      runtime.sendMessage({
        type: 0,
        tabId: tabsList[activeIndex].id
      })
    }
  })

  function cleanTabWrapper(e) {
    let tabMask = document.querySelector('#tab-mask')
    let tabWrapper = document.querySelector('#tab-wrapper')
    tabMask && tabMask.addEventListener('click', (e) => {
      e.stopPropagation()
      document.body.removeChild(tabWrapper)
    })
  }

  // 设置滚动条的位置
  function setScrollPos(activeIndex) {
    let num = 0
    if (activeIndex > (MAX_TAB_LENGTH - 1) && activeIndex < (tabsNum - 1)) {
      num = (activeIndex + 1) - MAX_TAB_LENGTH
    }
    let tabBox = document.querySelector('#tab-box')
    tabBox && (tabBox.scrollTop = num * 28)
  }

  function setActiveIndex(index) {
    let tabList = [...document.querySelectorAll('.tabs-li')]
    tabList.forEach(tab => {
      removeClass(tab, 'tabs-active')
    })
    addClass(tabList[index], 'tabs-active')
  }

  function createTabWrapper(tabs, cb) {
    showFlag = true
    tabsList = tabs
    let tabWrapper = document.createElement('div')
    let tabBox = document.createElement('div')
    let tabMask = document.createElement('div')
    tabWrapper.id = 'tab-wrapper'
    tabBox.id = 'tab-box'
    tabMask.id = 'tab-mask'
    tabBox.appendChild(createTabsList(tabs))
    tabWrapper.appendChild(tabMask)
    tabWrapper.appendChild(tabBox)

    document.body.appendChild(tabWrapper)

    cb && cb()
  }

  function createTabsList(tabs) {
    let ulWrapper = document.createElement('ul')
    ulWrapper.className = 'tabs-ul'
    tabsNum = tabs.length
    tabs.forEach((tab, index) => {
      let liNode = document.createElement('li')
      liNode.innerHTML = `<img src=${tab.favIconUrl} class="tab-img"><p class="tab-title">${tab.title}</p>`
      if (tab.active) {
        liNode.className = 'tabs-li tabs-active'
        activeIndex = index
      } else {
        liNode.className = 'tabs-li'
      }
      // liNode.innerHTML = tab.title
      ulWrapper.appendChild(liNode)
    })
    return ulWrapper
  }

  function setTabsListStyle() {
    const styleTag = document.createElement('style')
    const styleObj = {
      '#tab-wrapper *': {
        margin: 0,
        padding: 0
      },
      '#tab-wrapper': {
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        'z-index': 900
      },
      '#tab-mask': {
        position: 'absolute',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        'background-color': '#000',
        opacity: .3
      },
      '#tab-box': {
        position: 'absolute',
        top: '40%',
        left: '50%',
        transform: 'translate(-50%, -50%)',
        'background-color': '#fff',
        'z-index': 999,
        width: '300px',
        height: '200px',
        'overflow-y': 'auto'
      },
      '#tab-wrapper .tabs-ul .tabs-li': {
        'list-style': 'none',
        'height': '28px',
        'line-height': '28px',
      },
      '.tabs-li .tab-img': {
        width: '16px',
        height: '16px',
        display: 'inline-block',
        position: 'relative',
        top: '-8px'
      },
      '.tabs-li .tab-title': {
        'max-width': '80%',
        'white-space': 'nowrap',
        'overflow': 'hidden',
        'text-overflow': 'ellipsis',
        'display': 'inline-block'
      },
      '.tabs-li.tabs-active': {
        'background-color': '#000',
        color: '#fff'
      }
    }
    styleTag.innerText = toCss(styleObj)
    document.head.appendChild(styleTag)
  }

  function hasClass(el, className) {
    let reg = new RegExp('(^|\\s)' + className + '(\\s|$)')
    return reg.test(el.className)
  }

  function addClass(el, className) {
    if (hasClass(el, className)) {
      return
    }

    let newClass = el.className.split(' ')
    newClass.push(className)
    el.className = newClass.join(' ')
  }

  function removeClass(el, className) {
    if (!hasClass(el, className)) {
      return
    }

    const reg = new RegExp('(^|\\s)' + className + '(\\s|$)', 'g')
    el.className = el.className.replace(reg, ' ')
  }

  function toCss(obj = {}) {
    if (!obj || typeof obj !== 'object') {
      throw new Error('Invalid object provided')
    }

    const selectors = Object.keys(obj)
    return selectors
      .map(selector => {
        const definition = obj[selector]
        const rules = Object.keys(definition).map(rule => `${rule}:${definition[rule]}`).join(';')
        return `${selector}{${rules}}`
      })
      .join('')
  }


  /* runtime.onMessage.addListener((request, sender, sendRes) => {
    console.log(sender.tab ? `from a content script: ${sender.tab.url}` : 'from the extension')
    if (request.greeting === 'Hello') {

    }
  }) */
})()