(() => {

  const mockData = [{
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: false,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }, {
    active: true,
    audible: false,
    autoDiscardable: true,
    discarded: false,
    favIconUrl: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/images/extension-icon64.png",
    height: 1006,
    highlighted: false,
    id: 227,
    incognito: false,
    index: 0,
    pinned: false,
    selected: false,
    status: "complete",
    title: "OneTab",
    url: "chrome-extension://chphlpgkkbolifaimnlloiipkdnihall/onetab.html",
    width: 1920,
    windowId: 1,
  }]
  const CTRL_KEY_CODE = 17
  const TAB_KEY_CODE = 81
  let showFlag = false
  let activeIndex = null
  let tabsNum = 0
  let tabsList = []
  let activeTab = null
  const {
    runtime
  } = chrome 

  document.addEventListener('keydown', e => {
    let currKey = e.keyCode
    if (e.ctrlKey && currKey === TAB_KEY_CODE) {
      if (showFlag) {
        if (activeIndex >= 0) {
          setActiveIndex(activeIndex)
          activeIndex++
          if (activeIndex === tabsNum) activeIndex = 0
        }
      } else {
        runtime.sendMessage({
          greeting: 'Hello'
        }, ({
          arrTabs
        }) => {
          createTabWrapper(arrTabs)
        })
        // createTabWrapper(mockData, cleanTabWrapper)
      }
      // setTabsListStyle()
    }
  })

  document.addEventListener('keyup', e => {
    if (!e.ctrlKey && e.keyCode === CTRL_KEY_CODE) {
      let tabWrapper = document.querySelector('#tab-wrapper')
      document.body.removeChild(tabWrapper)
      showFlag = false

      runtime.sendMessage({
        type: 0,
        tabId: tabsList[activeIndex].id
      })     
    }
  })

  function cleanTabWrapper(e) {
    let tabMask = document.querySelector('#tab-mask')
    let tabWrapper = document.querySelector('#tab-wrapper')
    tabMask && tabMask.addEventListener('click', (e) => {
      e.stopPropagation()
      document.body.removeChild(tabWrapper)
    })
  }

  function setActiveIndex(index) {
    let tabList = [...document.querySelectorAll('.tabs-li')]
    tabList.forEach(tab => {
      removeClass(tab, 'tabs-active')
    })
    addClass(tabList[index], 'tabs-active')
  }

  function createTabWrapper(tabs, cb) {
    showFlag = true
    tabsList = tabs
    let tabWrapper = document.createElement('div')
    let tabBox = document.createElement('div')
    let tabMask = document.createElement('div')
    tabWrapper.id = 'tab-wrapper'
    tabBox.id = 'tab-box'
    tabMask.id = 'tab-mask'
    tabBox.appendChild(createTabsList(tabs))
    tabWrapper.appendChild(tabMask)
    tabWrapper.appendChild(tabBox)

    document.body.appendChild(tabWrapper)

    cb && cb()
  }

  function createTabsList(tabs) {
    let ulWrapper = document.createElement('ul')
    ulWrapper.className = 'tabs-ul'
    tabsNum = tabs.length
    tabs.forEach((tab, index) => {
      let liNode = document.createElement('li')
      if (tab.active) {
        liNode.className = 'tabs-li tabs-active'
        activeIndex = index
      } else {
        liNode.className = 'tabs-li'
      }
      liNode.innerHTML = tab.title
      ulWrapper.appendChild(liNode)
    })
    return ulWrapper
  }

  function setTabsListStyle() {
    const styleTag = document.createElement('style')
    styleTag.innerText = `
      .tab-wrapper * {
        margin: 0;
        padding: 0;
      }
      .tab-wrapper ul li {
        list-style: none;
      }
    `
    styleTag.innerText.replace('\<br\>', '')
    document.head.appendChild(styleTag)
  }

  function hasClass(el, className) {
    let reg = new RegExp('(^|\\s)' + className + '(\\s|$)')
    return reg.test(el.className)
  }

  function addClass(el, className) {
    if (hasClass(el, className)) {
      return
    }

    let newClass = el.className.split(' ')
    newClass.push(className)
    el.className = newClass.join(' ')
  }

  function removeClass(el, className) {
    if (!hasClass(el, className)) {
      return
    }

    const reg = new RegExp('(^|\\s)' + className + '(\\s|$)', 'g')
    el.className = el.className.replace(reg, ' ')
  }


  /* runtime.onMessage.addListener((request, sender, sendRes) => {
    console.log(sender.tab ? `from a content script: ${sender.tab.url}` : 'from the extension')
    if (request.greeting === 'Hello') {

    }
  }) */
})()